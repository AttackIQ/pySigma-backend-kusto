{"_ASim_NetworkSession_AzureFirewallV01": {"body": "let parser = (disabled:bool=false) {\r\n    let AzureFirewallNetworkRuleLogs = \r\n        AzureDiagnostics\r\n        | where not(disabled)\r\n        | where Category == \"AzureFirewallNetworkRule\"\r\n        | where isnotempty(msg_s)\r\n        | project msg_s, OperationName, SubscriptionId, ResourceId, TimeGenerated, Type, _ResourceId;\r\n    let AzureFirewallSessionLogs = \r\n        AzureFirewallNetworkRuleLogs\r\n        | where OperationName in (\"AzureFirewallNetworkRuleLog\",\"AzureFirewallThreatIntelLog\")\r\n        | parse-where\r\n            msg_s with           NetworkProtocol:string \r\n            \" request from \"     SrcIpAddr:string\r\n            \":\"                  SrcPortNumber:int\r\n            \" to \"               DstIpAddr:string\r\n            \":\"                  DstPortNumber:int\r\n            \". Action: \"         DvcAction:string\r\n            \".\"                  *\r\n        | project-away msg_s\r\n        | extend NetworkIcmpCode = iff(NetworkProtocol startswith \"ICMP\", toint(extract (\"type=(\\\\d+)\",1,NetworkProtocol)), int(null))\r\n        | extend NetworkIcmpType = iff(isnotnull(NetworkIcmpCode), _ASIM_LookupICMPType(NetworkIcmpCode), \"\")\r\n        | extend NetworkProtocol = iff(NetworkProtocol startswith \"ICMP\", \"ICMP\", NetworkProtocol)\r\n        | extend EventSeverity = case (\r\n            OperationName  == \"AzureFirewallThreatIntelLog\", \"Medium\",\r\n            DvcAction == \"Deny\", \"Low\",\r\n            \"Informational\")\r\n        | extend EventResult = iff(DvcAction == \"Allow\", \"Success\", \"Failure\")\r\n        ;\r\n    let AzureFirewallNATLogs = \r\n        AzureFirewallNetworkRuleLogs\r\n        | where OperationName == \"AzureFirewallNatRuleLog\"\r\n        | parse-where\r\n            msg_s with           NetworkProtocol:string \r\n            \" request from \"     SrcIpAddr:string\r\n            \":\"                  SrcPortNumber:int\r\n            \" to \"               DstIpAddr:string\r\n            \":\"                  DstPortNumber:int\r\n            \" was DNAT'ed to \"   DstNatIpAddr:string\r\n            \":\"                  DstNatPortNumber:int\r\n        | project-away msg_s\r\n        | extend EventSeverity = \"Informational\"\r\n        | extend EventResult = \"Success\"\r\n        | extend DvcAction = \"Allow\"\r\n        ;\r\n    union AzureFirewallSessionLogs, AzureFirewallNATLogs\r\n    | extend\r\n        EventVendor=\"Microsoft\",\r\n        EventProduct=\"Azure Firewall\",\r\n        EventType=\"NetworkSession\",\r\n        EventCount=toint(1),\r\n        EventSchemaVersion=\"0.2.2\",\r\n        EventSchema=\"NetworkSession\",\r\n        DvcIdType = \"AzureResourceId\"\r\n    | project-rename\r\n        DvcSubscriptionId = SubscriptionId,\r\n        DvcId = ResourceId\r\n    // -- Aliases\r\n    | extend\r\n        IpAddr = SrcIpAddr,\r\n        Src = SrcIpAddr,\r\n        Dst = DstIpAddr,\r\n        Dvc = DvcId,\r\n        EventStartTime = TimeGenerated,\r\n        EventEndTime = TimeGenerated\r\n    | project-keep\r\n        Src*,\r\n        Dst*,\r\n        Event*,\r\n        Dvc*,\r\n        Network*,\r\n        IpAddr,\r\n        Type,\r\n        _ResourceId,\r\n        TimeGenerated\r\n};\r\nparser (disabled)", "params": "disabled:bool = false"}}