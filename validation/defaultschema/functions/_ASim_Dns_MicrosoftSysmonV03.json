{"_ASim_Dns_MicrosoftSysmonV03": {"body": "let RCodeTable=datatable(DnsResponseCode:int,DnsResponseCodeName:string)[\r\n    // See https://docs.microsoft.com/windows/win32/debug/system-error-codes--9000-11999-\r\n    0, 'NOERROR'\r\n  , 9001, \"FORMERR\"\r\n  , 9002,\"SERVFAIL\"\r\n  , 9003,'NXDOMAIN'\r\n  , 9004,'NOTIMP'\r\n  , 9005,'REFUSED'\r\n  , 9006,'YXDOMAIN'\r\n  , 9007,'YXRRSET'\r\n  , 9008,'NXRRSET'\r\n  , 9009,'NOTAUTH'\r\n  , 9010,'NOTZONE'\r\n  , 9011,'DSOTYPENI'\r\n  , 9016,'BADVERS'\r\n  , 9016,'BADSIG'\r\n  , 9017,'BADKEY'\r\n  , 9018,'BADTIME'\r\n  , 9019,'BADMODE'\r\n  , 9020,'BADNAME'\r\n  , 9021,'BADALG'\r\n  , 9022,'BADTRUNC'\r\n  , 9023,'BADCOOKIE'\r\n  , 1460, 'TIMEOUT'\r\n  ];\r\nlet ParsedDnsEvent_Event =(disabled:bool=false) {\r\n    Event | where not(disabled)\r\n    | project EventID, EventData, Computer, TimeGenerated, _ResourceId, _SubscriptionId, Source // , _ItemId \r\n    | where Source == \"Microsoft-Windows-Sysmon\" and EventID==22\r\n    | project-away Source, EventID\r\n    | parse EventData with \r\n       *'<Data Name=\"RuleName\">' RuleName:string '</Data>' \r\n        '<Data Name=\"UtcTime\">' EventEndTime:datetime '</Data>'\r\n        '<Data Name=\"ProcessGuid\">{' SrcProcessGuid:string '}</Data>'\r\n        '<Data Name=\"ProcessId\">' SrcProcessId:string '</Data>'\r\n        '<Data Name=\"QueryName\">' DnsQuery:string '</Data>'\r\n        '<Data Name=\"QueryStatus\">' DnsResponseCode:int  '</Data>'\r\n        '<Data Name=\"QueryResults\">' DnsResponseName:string '</Data>'\r\n        '<Data Name=\"Image\">' Process:string '</Data>'\r\n        '<Data Name=\"Image\">' SrcProcessName:string '</Data>'\r\n    | parse EventData with * '<Data Name=\"User\">'SrcUsername:string '</Data>' *\r\n    | project-away EventData\r\n};\r\nlet ParsedDnsEvent_WindowsEvent =(disabled:bool=false) {\r\n    WindowsEvent | where not(disabled)\r\n    | project EventID, EventData, Computer, TimeGenerated, _ResourceId, _SubscriptionId,  Provider // , _ItemId \r\n    | where Provider == \"Microsoft-Windows-Sysmon\" and EventID == 22\r\n    | project-away Provider, EventID      \r\n    | extend \r\n        RuleName = tostring(EventData.RuleName),\r\n        EventEndTime = todatetime(EventData.UtcTime),\r\n        SrcProcessGuid = extract ('^{(.*)}$', 1, tostring(EventData.ProcessGuid), typeof(string)),\r\n        SrcProcessId = tostring(EventData.ProcessId),  \r\n        DnsQuery = tostring(EventData.QueryName),\r\n        DnsResponseCode = toint(EventData.QueryStatus),\r\n        DnsResponseName = tostring(EventData.QueryResults),\r\n        SrcProcessName = tostring(EventData.Image),\r\n        SrcUsername = tostring(EventData.User)\r\n    | project-away EventData\r\n};\r\nunion isfuzzy=true ParsedDnsEvent_Event(disabled), ParsedDnsEvent_WindowsEvent(disabled)\r\n  | lookup RCodeTable on DnsResponseCode\r\n  | project-rename \r\n      DvcHostname = Computer,\r\n      // EventUid = _ItemId, \r\n      DvcScopeId = _SubscriptionId\r\n  | extend\r\n      EventOriginalType = '22',\r\n      EventCount=int(1),\r\n      EventProduct = 'Sysmon',\r\n      EventVendor = 'Microsoft',\r\n      EventSchema = 'Dns',\r\n      EventSchemaVersion=\"0.1.3\",\r\n      EventType = 'lookup',\r\n      EventResult = iff (DnsResponseCode == 0,'Success','Failure'),\r\n      EventStartTime = EventEndTime,\r\n      EventSubType= 'response',\r\n      EventSeverity= iif (DnsResponseCode == 0, 'Informational', 'Low'),\r\n      SrcUsernameType = 'Windows'\r\n  // -- Aliases\r\n  | extend \r\n      EventResultDetails = DnsResponseCodeName,\r\n      Domain = DnsQuery,\r\n      Dvc = DvcHostname,\r\n      SrcHostname = DvcHostname,\r\n      Hostname=DvcHostname,\r\n      Src = DvcHostname,\r\n      DnsResponseCode = toint(iff (DnsResponseCode > 9000 and DnsResponseCode < 9100, DnsResponseCode-9000, DnsResponseCode)),\r\n      User = SrcUsername,\r\n      Process = SrcProcessName\r\n", "params": "disabled:bool = false"}}