{"_ASim_Dns_AzureFirewallV03": {"body": "let DNS_query=(disabled:bool=false){\r\n  AzureDiagnostics | where not(disabled)\r\n  // | where ResourceType == \"AZUREFIREWALLS\" -- Implicit in the next line\r\n  | where Category == \"AzureFirewallDnsProxy\"\r\n  | where msg_s startswith \"DNS Request:\"\r\n  | project msg_s, TimeGenerated, ResourceId\r\n  | parse msg_s with\r\n      \"DNS Request: \" \r\n      SrcIpAddr:string \":\" SrcPortNumber:int \r\n      \" - \" EventOriginalUid:string \r\n      \" \" DnsQueryTypeName:string \r\n      \" \" DnsQueryClassName:string\r\n      \" \" DnsQuery:string\r\n      \". \" NetworkProtocol:string \r\n      \" \" SrcBytes:int \r\n      \" \" DnsDNSSECflag:bool \r\n      \" \" DnsDNSSECBufferSize:int \r\n      \" \" EventResultDetails:string \r\n      \" \" DnsFlags:string\r\n      \" \" DstBytes:int\r\n      \" \" DnsNetworkDuration:double\r\n      \"s\"\r\n  | project-away msg_s\r\n  | extend\r\n    EventResult = iff (EventResultDetails == \"NOERROR\", \"Success\", \"Failure\"),\r\n    EventSubType = \"response\",\r\n    DnsNetworkDuration = toint(DnsNetworkDuration*1000)     \r\n};\r\nlet DNS_error=(disabled:bool=false) {\r\n  AzureDiagnostics | where not(disabled)\r\n  // | where ResourceType == \"AZUREFIREWALLS\" -- Implicit in the next line\r\n  | where Category == \"AzureFirewallDnsProxy\"\r\n  | project msg_s, TimeGenerated, ResourceId\r\n  | where msg_s startswith \" Error:\"\r\n  | parse msg_s with \r\n      \" Error: \" nu:string \r\n      \" \" DnsQuery:string \r\n      \". \" DnsQueryTypeName:string \r\n      \": \" op:string \r\n      \" \" NetworkProtocol:string\r\n      \" \" SrcIpAddr:string \":\" SrcPortNumber:int \r\n      \"->\" DstIpAddr:string \":\" DstPortNumber:int  \r\n      \": \" EventResultOriginalDetails:string\r\n  | project-away msg_s\r\n  | extend \r\n    EventResult = \"Failure\",\r\n    EventSubType = \"request\"\r\n};\r\nlet DNS = (disabled:bool=false) {\r\n  union DNS_query(disabled), DNS_error(disabled)\r\n  | extend\r\n    NetworkProtocol = toupper(NetworkProtocol)\r\n  | project-rename\r\n      DvcId = ResourceId\r\n  | extend\r\n      DvcIdType = \"AzureResourceId\",\r\n      EventCount = int(1),\r\n      EventStartTime = TimeGenerated,\r\n      EventVendor = \"Microsoft\",\r\n      EventProduct = \"Azure Firewall\",\r\n      EventSchema = \"Dns\",\r\n      EventSchemaVersion = \"0.1.3\",\r\n      EventEndTime = TimeGenerated, \r\n      EventType = 'Query',\r\n      DnsFlagsAuthenticated = DnsFlags has \"aa\",\r\n      DnsFlagsAuthoritative = DnsFlags has \"ad\",\r\n      DnsFlagsCheckingDisabled = DnsFlags has \"cd\",\r\n      DnsFlagsRecursionAvailable = DnsFlags has \"ra\",\r\n      DnsFlagsRecursionDesired = DnsFlags has \"rd\",\r\n      DnsFlagsTruncates = DnsFlags has \"tc\"\r\n  | extend\r\n     // -- Aliases\r\n      DnsResponseCodeName=EventResultDetails,\r\n      Domain=DnsQuery,\r\n      IpAddr=SrcIpAddr,\r\n      Src=SrcIpAddr,\r\n      Dst=DstIpAddr,\r\n      Duration = DnsNetworkDuration,\r\n      Dvc=DvcId\r\n  | extend\r\n      // -- Backward Compatibility\r\n      Query = DnsQuery,\r\n      QueryTypeName = DnsQueryTypeName,\r\n      ResponseCodeName = DnsResponseCodeName,\r\n      Flags = DnsFlags\r\n};\r\nDNS(disabled)", "params": "disabled:bool = false"}}