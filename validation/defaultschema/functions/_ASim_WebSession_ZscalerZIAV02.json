{"_ASim_WebSession_ZscalerZIAV02": {"body": "let parser=(disabled:bool=false){\r\nlet DvcActionLookup = datatable (DeviceAction:string, DvcAction: string) \r\n[\r\n  'Allowed', 'Allow',\r\n  'Blocked', 'Deny'\r\n]; \r\nCommonSecurityLog | where not(disabled)\r\n| where DeviceVendor == \"Zscaler\"\r\n| where DeviceProduct == \"NSSWeblog\"\r\n// Event fields\r\n| extend \r\n  EventCount=int(1), \r\n  EventStartTime=TimeGenerated,  \r\n  EventVendor = \"Zscaler\", \r\n  EventProduct = \"ZIA Proxy\", \r\n  EventSchema = \"WebSession\", \r\n  EventSchemaVersion=\"0.2.3\", \r\n  EventType = 'HTTPsession',\r\n  EventEndTime=TimeGenerated\r\n| project-rename\r\n  EventProductVersion = DeviceVersion,\r\n  NetworkApplicationProtocol = ApplicationProtocol,\r\n  HttpContentType = FileType,\r\n  HttpUserAgent = RequestClientApplication,\r\n  HttpRequestMethod = RequestMethod,\r\n  DstAppName = DestinationServiceName,\r\n  DstIpAddr = DestinationIP,\r\n  DstFQDN = DestinationHostName,\r\n  SrcIpAddr = SourceIP,\r\n  SrcUsername = SourceUserName,\r\n  SrcNatIpAddr= SourceTranslatedAddress,\r\n  SrcUserDepartment = SourceUserPrivileges, // Not part of the standard schema\r\n  UrlCategory = DeviceCustomString2,\r\n  ThreatName = DeviceCustomString5,\r\n  FileMD5 = DeviceCustomString6\r\n// -- Parse\r\n| parse AdditionalExtensions with \r\n    * \"rulelabel=\" RuleName:string \";\"\r\n    \"ruletype=\" ruletype:string \";\"\r\n    \"urlclass=\" urlclass:string \";\"\r\n    \"devicemodel=\" * \r\n// -- Calculated fields\r\n| lookup DvcActionLookup on DeviceAction\r\n| extend\r\n  // -- Adjustment to support both old and new CSL fields.\r\n  EventOriginalResultDetails = coalesce(\r\n    column_ifexists(\"Reason\", \"\"),\r\n    extract(@'reason=(.*?)(?:;|$)',1, AdditionalExtensions, typeof(string))\r\n  ),\r\n  EventResultDetails = coalesce(\r\n    column_ifexists(\"EventOutcome\", \"\"),\r\n    extract(@'outcome=(.*?)(?:;|$)',1, AdditionalExtensions, typeof(string))\r\n  ),\r\n  ThreatRiskLevel = coalesce(\r\n    toint(column_ifexists(\"fieldDeviceCustomNumber1\", int(null))),\r\n    toint(column_ifexists(\"DeviceCustomNumber1\",int(null)))\r\n  ),\r\n  DvcHostname = tostring(Computer),\r\n  SrcBytes = toint(SentBytes),\r\n  DstBytes = toint(ReceivedBytes),\r\n  Url = iff (RequestURL == \"\", \"\", strcat (tolower(NetworkApplicationProtocol), \"://\", url_decode(RequestURL))),\r\n  UrlCategory = strcat (urlclass, \"/\", UrlCategory),\r\n  ThreatCategory = iff(DeviceCustomString4 == \"None\", \"\", strcat (DeviceCustomString3, \"/\", DeviceCustomString4)),\r\n  RuleName = iff (RuleName == \"None\", \"\", strcat (ruletype, \"/\", RuleName)),\r\n  FileMD5 = iff (FileMD5 == \"None\", \"\", FileMD5),\r\n  HttpReferrer = iff (RequestContext == \"None\", \"\", url_decode(RequestContext)),\r\n  DstAppName = iff (DstAppName == \"General Browsing\", \"\", DstAppName),\r\n  DstFQDNparts = split (DstFQDN, \".\"),\r\n  DstHostnameNotAddr = DstIpAddr != DstFQDN\r\n| extend\r\n  DstHostname = iff (DstHostnameNotAddr, tostring(DstFQDNparts[0]), DstFQDN),\r\n  DstDomain = iff (DstHostnameNotAddr, strcat_array(array_slice(DstFQDNparts,1,-1),\".\"), \"\"),\r\n  DstFQDN = iff (DstHostnameNotAddr, DstFQDN, \"\") \r\n// -- Enrichment\r\n| extend\r\n  EventResult = iff (EventResultDetails == \"NA\" or toint(EventResultDetails) >= 400, \"Failure\", \"Success\"),\r\n  EventSeverity = case (ThreatRiskLevel > 90, \"High\", ThreatRiskLevel > 60, \"Medium\", ThreatRiskLevel > 10, \"Low\",  \"Informational\"),\r\n  DstAppType = \"SaaS application\",\r\n  DstDomainType = iff (DstHostnameNotAddr, \"FQDN\", \"\"),\r\n  SrcUsernameType = \"UPN\"\r\n// -- Aliases\r\n| extend\r\n  Dvc = DvcHostname,\r\n  UserAgent = HttpUserAgent,\r\n  User = SrcUsername,\r\n  HttpStatusCode = EventResultDetails,\r\n  IpAddr = SrcNatIpAddr,\r\n  Hash = FileMD5,\r\n  FileHashType = iff(FileMD5 == \"\", \"\", \"MD5\")\r\n| project-away \r\n  DstFQDNparts, AdditionalExtensions, DeviceCustom*\r\n};\r\nparser (disabled)", "params": "disabled:bool = false"}}