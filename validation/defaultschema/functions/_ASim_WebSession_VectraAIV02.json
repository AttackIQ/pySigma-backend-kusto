{"_ASim_WebSession_VectraAIV02": {"body": "let parser = (disabled: bool = false, pack:bool = false)\r\n{\r\n  let NetworkDirectionLookup = datatable(local_orig_b:bool, local_resp_b:bool, NetworkDirection:string)\r\n  [\r\n      false, true, 'Inbound',\r\n      true, false, 'Outbound',\r\n      true, true, 'Local',\r\n      false, false, 'Local'\r\n  ];\r\n  let NetworkProtocolVersionLookup = datatable(id_ip_ver_s:string, NetworkApplicationProtocol:string)\r\n  [\r\n      'ipv4', 'IPv4',\r\n      'ipv6', 'IPv6'\r\n  ];\r\n  let HostnameRegex = @'^[a-zA-Z0-9-]{1,61}$';\r\n  VectraStream_CL\r\n  | where metadata_type_s == 'metadata_httpsessioninfo'\r\n  | extend EventResult = iff(tolong(status_code_d) >= 400, \"Failure\", \"Success\")\r\n  | project-rename\r\n      DvcDescription = hostname_s,\r\n      DstDescription = resp_hostname_s,\r\n      SrcDescription = orig_hostname_s,\r\n      DstIpAddr = id_resp_h_s,\r\n      EventOriginalUid = uid_s,\r\n      HttpContentType = resp_mime_types_s,\r\n      HttpReferrer = referrer_s,\r\n      HttpRequestMethod = method_s,\r\n      HttpUserAgent = user_agent_s,\r\n      DvcId = sensor_uid_s,\r\n      // -- community id is just a hash of addresses and ports, and not unique for the session\r\n      // NetworkSessionId = community_id_s,\r\n      SrcIpAddr = id_orig_h_s,\r\n      SrcSessionId = orig_sluid_s,\r\n      DstSessionId = resp_sluid_s,\r\n      HttpResponseCacheControl = response_cache_control_s,\r\n      HttpRequestCacheControl = request_cache_control_s,\r\n      HttpCookie = cookie_s,\r\n      HttpResponseExpires = response_expires_s,\r\n      HttpIsProxied = is_proxied_b,\r\n      EventOriginalResultDetails = status_msg_s\r\n  | extend\r\n      DstHostname = iff (DstDescription startswith \"IP-\" or not(DstDescription matches regex HostnameRegex), \"\", DstDescription),\r\n      SrcHostname = iff (SrcDescription startswith \"IP-\" or not(SrcDescription matches regex HostnameRegex), \"\", SrcDescription),\r\n      DvcHostname = iff (DvcDescription startswith \"IP-\" or not(DvcDescription matches regex HostnameRegex), \"\", DvcDescription),\r\n      DstBytes = tolong(resp_ip_bytes_d),\r\n      DstPackets = tolong(resp_pkts_d),\r\n      DstPortNumber = toint(id_resp_p_d),\r\n      EventCount = toint(1),\r\n      EventStartTime = unixtime_milliseconds_todatetime(ts_d),\r\n      EventOriginalSubType = tostring(split(metadata_type_s, '_')[1]),\r\n      EventProduct = 'Vectra Stream',\r\n      EventResultDetails = tostring(toint(status_code_d)),\r\n      HttpRequestBodyBytes = tolong(request_body_len_d),\r\n      HttpResponseBodyBytes = tolong(response_body_len_d),\r\n      HttpRequestHeaderCount = toint(request_header_count_d),\r\n      HttpResponseHeaderCount = toint(response_header_count_d),\r\n      EventSchema = 'WebSession',\r\n      EventSchemaVersion='0.2.3',\r\n      DvcIdType = 'VectraId',\r\n      EventSeverity = iff (EventResult == 'Success', 'Informational', 'Low'),\r\n      EventType = 'HTTPsession',\r\n      EventVendor = 'Vectra AI',\r\n      SrcBytes = tolong(orig_ip_bytes_d),\r\n      SrcPackets = tolong(orig_pkts_d),\r\n      SrcPortNumber = toint(id_orig_p_d),\r\n      Url = strcat('http://', host_s, uri_s)\r\n  | lookup NetworkDirectionLookup on local_orig_b, local_resp_b\r\n  | lookup NetworkProtocolVersionLookup on id_ip_ver_s\r\n  // -- preserving non-normalized important fields\r\n  | extend AdditionalFields = iff (\r\n      pack, \r\n      bag_pack (\r\n        \"first_orig_resp_data_pkt\", first_orig_resp_data_pkt_s,\r\n        \"first_resp_orig_data_pkt\", first_resp_orig_data_pkt_s,\r\n        \"orig_huid\", orig_huid_s,\r\n        \"resp_huid\", resp_huid_s,\r\n        \"community_id\", community_id_s,\r\n        \"resp_multihome\", resp_multihomed_b,\r\n        \"host_multihomed\", host_multihomed_b,\r\n        \"first_orig_resp_data_pkt_time\", unixtime_milliseconds_todatetime(first_orig_resp_data_pkt_time_d),\r\n        \"first_orig_resp_pkt_time\", unixtime_milliseconds_todatetime(first_orig_resp_pkt_time_d),\r\n        \"first_resp_orig_data_pkt_time\", unixtime_milliseconds_todatetime(first_resp_orig_data_pkt_time_d),\r\n        \"first_resp_orig_pkt_time\", unixtime_milliseconds_todatetime(first_resp_orig_pkt_time_d)\r\n      ),\r\n      dynamic([])\r\n    )\r\n  | project-away\r\n      *_d, *_s, *_b, *_g, Computer, MG, ManagementGroupName, RawData, SourceSystem, TenantId\r\n  | extend\r\n      Dst = DstIpAddr,\r\n      Dvc = DvcId,\r\n      EventEndTime = EventStartTime,\r\n      Hostname = DstHostname,\r\n      HttpStatusCode = EventResultDetails,\r\n      IpAddr = SrcIpAddr,\r\n      NetworkBytes = SrcBytes + DstBytes,\r\n      NetworkPackets = SrcPackets + DstPackets,\r\n      //SessionId = NetworkSessionId,\r\n      Src = SrcIpAddr,\r\n      UserAgent = HttpUserAgent \r\n};\r\nparser (disabled=disabled, pack=pack)", "params": "disabled:bool = false, pack:bool = false"}}