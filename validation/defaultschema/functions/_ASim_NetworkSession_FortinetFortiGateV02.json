{"_ASim_NetworkSession_FortinetFortiGateV02": {"body": "let EventLookup=datatable(DeviceAction:string,DvcAction:string,EventResult:string,EventResultDetails:string)\r\n[\r\n    \"accept\",\"Allow\",\"Success\",\"\"\r\n    , \"client-rst\",\"Reset Source\",\"Failure\",\"\"\r\n    , \"close\",\"\",\"Success\",\"\"\r\n    , \"deny\",\"Deny\",\"Failure\",\"\"\r\n    , \"ip-conn\",\"\",\"Failure\",\"IP connection error\"\r\n    , \"server-rst\",\"Reset Destination\",\"Failure\",\"\"\r\n    , \"timeout\",\"\",\"Failure\",\"\"\r\n];\r\nlet ProtocolLookup=datatable(Protocol:string,NetworkProtocol:string)\r\n[\r\n    \"0\",\"HOPOPT\"\r\n    , \"1\",\"ICMP\"\r\n    , \"2\",\"IGMP\"\r\n    , \"3\",\"GGP\"\r\n    , \"4\",\"IPv4\"\r\n    , \"5\",\"ST\"\r\n    , \"6\",\"TCP\"\r\n    , \"7\",\"CBT\"\r\n    , \"8\",\"EGP\"\r\n    , \"9\",\"IGP\"\r\n    , \"10\",\"BBN-RCC-MON\"\r\n    , \"11\",\"NVP-II\"\r\n    , \"12\",\"PUP\"\r\n    , \"13\",\"ARGUS (deprecated)\"\r\n    , \"14\",\"EMCON\"\r\n    , \"15\",\"XNET\"\r\n    , \"16\",\"CHAOS\"\r\n    , \"17\",\"UDP\"\r\n    , \"18\",\"MUX\"\r\n    , \"19\",\"DCN-MEAS\"\r\n    , \"20\",\"HMP\"\r\n    , \"21\",\"PRM\"\r\n    , \"22\",\"XNS-IDP\"\r\n    , \"23\",\"TRUNK-1\"\r\n    , \"24\",\"TRUNK-2\"\r\n    , \"25\",\"LEAF-1\"\r\n    , \"26\",\"LEAF-2\"\r\n    , \"27\",\"RDP\"\r\n    , \"28\",\"IRTP\"\r\n    , \"29\",\"ISO-TP4\"\r\n    , \"30\",\"NETBLT\"\r\n    , \"31\",\"MFE-NSP\"\r\n    , \"32\",\"MERIT-INP\"\r\n    , \"33\",\"DCCP\"\r\n    , \"34\",\"3PC\"\r\n    , \"35\",\"IDPR\"\r\n    , \"36\",\"XTP\"\r\n    , \"37\",\"DDP\"\r\n    , \"38\",\"IDPR-CMTP\"\r\n    , \"39\",\"TP++\"\r\n    , \"40\",\"IL\"\r\n    , \"41\",\"IPv6\"\r\n    , \"42\",\"SDRP\"\r\n    , \"43\",\"IPv6-Route\"\r\n    , \"44\",\"IPv6-Frag\"\r\n    , \"45\",\"IDRP\"\r\n    , \"46\",\"RSVP\"\r\n    , \"47\",\"GRE\"\r\n    , \"48\",\"DSR\"\r\n    , \"49\",\"BNA\"\r\n    , \"50\",\"ESP\"\r\n    , \"51\",\"AH\"\r\n    , \"52\",\"I-NLSP\"\r\n    , \"53\",\"SWIPE (deprecated)\"\r\n    , \"54\",\"NARP\"\r\n    , \"55\",\"MOBILE\"\r\n    , \"56\",\"TLSP\"\r\n    , \"57\",\"SKIP\"\r\n    , \"58\",\"IPv6-ICMP\"\r\n    , \"59\",\"IPv6-NoNxt\"\r\n    , \"60\",\"IPv6-Opts\"\r\n    , \"61\",\"\"\r\n    , \"62\",\"CFTP\"\r\n    , \"63\",\"\"\r\n    , \"64\",\"SAT-EXPAK\"\r\n    , \"65\",\"KRYPTOLAN\"\r\n    , \"66\",\"RVD\"\r\n    , \"67\",\"IPPC\"\r\n    , \"68\",\"\"\r\n    , \"69\",\"SAT-MON\"\r\n    , \"70\",\"VISA\"\r\n    , \"71\",\"IPCV\"\r\n    , \"72\",\"CPNX\"\r\n    , \"73\",\"CPHB\"\r\n    , \"74\",\"WSN\"\r\n    , \"75\",\"PVP\"\r\n    , \"76\",\"BR-SAT-MON\"\r\n    , \"77\",\"SUN-ND\"\r\n    , \"78\",\"WB-MON\"\r\n    , \"79\",\"WB-EXPAK\"\r\n    , \"80\",\"ISO-IP\"\r\n    , \"81\",\"VMTP\"\r\n    , \"82\",\"SECURE-VMTP\"\r\n    , \"83\",\"VINES\"\r\n    , \"84\",\"TTP\"\r\n    , \"84\",\"IPTM\"\r\n    , \"85\",\"NSFNET-IGP\"\r\n    , \"86\",\"DGP\"\r\n    , \"87\",\"TCF\"\r\n    , \"88\",\"EIGRP\"\r\n    , \"89\",\"OSPFIGP\"\r\n    , \"90\",\"Sprite-RPC\"\r\n    , \"91\",\"LARP\"\r\n    , \"92\",\"MTP\"\r\n    , \"93\",\"AX.25\"\r\n    , \"94\",\"IPIP\"\r\n    , \"95\",\"MICP (deprecated)\"\r\n    , \"96\",\"SCC-SP\"\r\n    , \"97\",\"ETHERIP\"\r\n    , \"98\",\"ENCAP\"\r\n    , \"99\",\"\"\r\n    , \"100\",\"GMTP\"\r\n    , \"101\",\"IFMP\"\r\n    , \"102\",\"PNNI\"\r\n    , \"103\",\"PIM\"\r\n    , \"104\",\"ARIS\"\r\n    , \"105\",\"SCPS\"\r\n    , \"106\",\"QNX\"\r\n    , \"107\",\"A/N\"\r\n    , \"108\",\"IPComp\"\r\n    , \"109\",\"SNP\"\r\n    , \"110\",\"Compaq-Peer\"\r\n    , \"111\",\"IPX-in-IP\"\r\n    , \"112\",\"VRRP\"\r\n    , \"113\",\"PGM\"\r\n    , \"114\",\"\"\r\n    , \"115\",\"L2TP\"\r\n    , \"116\",\"DDX\"\r\n    , \"117\",\"IATP\"\r\n    , \"118\",\"STP\"\r\n    , \"119\",\"SRP\"\r\n    , \"120\",\"UTI\"\r\n    , \"121\",\"SMP\"\r\n    , \"122\",\"SM (deprecated)\"\r\n    , \"123\",\"PTP\"\r\n    , \"124\",\"ISIS over IPv4\"\r\n    , \"125\",\"FIRE\"\r\n    , \"126\",\"CRTP\"\r\n    , \"127\",\"CRUDP\"\r\n    , \"128\",\"SSCOPMCE\"\r\n    , \"129\",\"IPLT\"\r\n    , \"130\",\"SPS\"\r\n    , \"131\",\"PIPE\"\r\n    , \"132\",\"SCTP\"\r\n    , \"133\",\"FC\"\r\n    , \"134\",\"RSVP-E2E-IGNORE\"\r\n    , \"135\",\"Mobility Header\"\r\n    , \"136\",\"UDPLite\"\r\n    , \"137\",\"MPLS-in-IP\"\r\n    , \"138\",\"manet\"\r\n    , \"139\",\"HIP\"\r\n    , \"140\",\"Shim6\"\r\n    , \"141\",\"WESP\"\r\n    , \"142\",\"ROHC\"\r\n    , \"143\",\"Ethernet\"\r\n    , \"253\",\"\"\r\n    , \"254\",\"\"\r\n    , \"255\",\"Reserved\"];\r\nlet Parser=(disabled:bool=false){\r\n    CommonSecurityLog \r\n    | where not(disabled)\r\n    | where DeviceVendor == \"Fortinet\" and DeviceProduct startswith \"FortiGate\" and AdditionalExtensions has \"cat=traffic\"\r\n    | where DeviceAction != \"dns\"\r\n    | project Activity,AdditionalExtensions,DestinationIP,DestinationPort,DeviceAction,DeviceInboundInterface,DeviceName,DeviceOutboundInterface,DeviceProduct,DeviceVersion,LogSeverity,Protocol,ReceivedBytes,SentBytes,SourceIP,SourcePort,TimeGenerated\r\n    | project-rename DstBytes = ReceivedBytes\r\n        , DstInterfaceName = DeviceOutboundInterface\r\n        , DstIpAddr = DestinationIP\r\n        , DstPortNumber = DestinationPort\r\n        , Dvc = DeviceName\r\n        , EventMessage = Activity\r\n        , EventOriginalSeverity = LogSeverity\r\n        , EventProduct = DeviceProduct\r\n        , EventProductVersion = DeviceVersion\r\n        , SrcBytes = SentBytes\r\n        , SrcInterfaceName = DeviceInboundInterface\r\n        , SrcIpAddr = SourceIP\r\n        , SrcPortNumber = SourcePort\r\n    | lookup EventLookup on DeviceAction \r\n    | lookup ProtocolLookup on Protocol\r\n    | project-rename DvcOriginalAction = DeviceAction\r\n    | parse AdditionalExtensions with \"start=\" EventStartTime:datetime \r\n    \";\" * \"srcintfrole=\" SrcZone \r\n    \";\" * \"dstintfrole=\" DstZone\r\n    \";\" * \"externalID=\" NetworkSessionId\r\n    \";\" * \"policyid=\" NetworkRuleNumber:int\r\n    \";\" * \"dstcountry=\" DstGeoCountry\r\n    \";\" * \"srccountry=\" SrcGeoCountry\r\n    \";\" *\r\n    | parse AdditionalExtensions with * \"crscore=\" ThreatRiskLevel:int\r\n    \";\" *\r\n    | parse AdditionalExtensions with * \"duration=\" NetworkDuration:int\r\n    \";\" * \"sentpkt=\" SrcPackets:long\r\n    \";\" * \"rcvdpkt=\" DstPackets:long\r\n    \";\" *\r\n    | extend EventCount = int(1)\r\n        , EventSchema = \"NetworkSession\"\r\n        , EventSchemaVersion = \"0.2.3\"\r\n        , EventSeverity = iif(EventOriginalSeverity == 5, \"Informational\", \"\")\r\n        , EventType = \"NetworkSession\"\r\n        , EventVendor = \"Fortinet\"\r\n        , NetworkBytes = DstBytes + SrcBytes\r\n        , EventEndTime = TimeGenerated\r\n        , NetworkProtocolVersion = case(DstIpAddr contains \".\", \"IPv4\"\r\n            , DstIpAddr contains \":\", \"IPv6\"\r\n            , \"\")\r\n        , NetworkPackets = DstPackets + SrcPackets\r\n    | extend \r\n        Src = SrcIpAddr,\r\n        Dst = DstIpAddr,\r\n        SessionId = NetworkSessionId,\r\n        IpAddr = SrcIpAddr,\r\n        Rule = tostring(NetworkRuleNumber),\r\n        Duration = NetworkDuration\r\n    | project-away Protocol\r\n};\r\nParser (disabled=disabled)", "params": "disabled:bool = false"}}