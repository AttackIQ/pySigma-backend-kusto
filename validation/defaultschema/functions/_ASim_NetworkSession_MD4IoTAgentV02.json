{"_ASim_NetworkSession_MD4IoTAgentV02": {"body": "let DirectionNetworkEvents =\r\n  SecurityIoTRawEvent | where not(disabled)\r\n  | where RawEventName == \"NetworkActivity\"\r\n  | parse EventDetails with * ',\"LocalPort\":' LocalPort:int ',\"RemotePort\":' RemotePort:int ',' *\r\n  | extend outbound = LocalPort > RemotePort\r\n;\r\nlet parser = (T: (EventDetails: string)) {\r\n  T \r\n   | parse EventDetails with \r\n    '{\"LocalAddress\":\"' LocalAddress:string '\",'\r\n    '\"RemoteAddress\":\"' RemoteAddress:string '\",'\r\n    *\r\n    '\"BytesIn\":' BytesIn:long ','\r\n    '\"BytesOut\":' BytesOut:long ','\r\n    '\"Protocol\":\"' Protocol:string '\",'\r\n    '\"ProcessId\":' ProcessId:string ','\r\n    '\"UserId\":' UserId:string ','\r\n    '\"ApplicationProtocol\":\"' ApplicationProtocol:string '\",'\r\n    * // '\"AzureResourceId\":\"' AzureResourceId:string '\",'\r\n    '\"DeviceId\":\"' DeviceId:string '\",'\r\n    '\"MessageSource\":\"' MessageSource:string '\",'\r\n    '\"OriginalEventId\":\"' OriginalEventId:string '\",'\r\n    '\"TimestampUTC\":\"' TimestampUTC:datetime '\",'\r\n    *\r\n}\r\n; \r\nlet OutboundNetworkEvents = \r\n  DirectionNetworkEvents\r\n  | where outbound\r\n  | invoke parser ()\r\n  | project-rename\r\n     SrcBytes = BytesOut,\r\n     DstBytes = BytesIn,\r\n     SrcPortNumber = LocalPort,\r\n     DstIpAddr = RemoteAddress,\r\n     DstPortNumber = RemotePort,\r\n     SrcProcessId = ProcessId\r\n  | extend\r\n     SrcIpAddr = LocalAddress,\r\n     SrcDvcIdType = \"MD4IoTid\",\r\n     SrcUserId = UserId,\r\n     SrcUserIdType = \"UID\",\r\n     SrcDvcId = DeviceId,\r\n     Process = SrcProcessId, // alias\r\n     SrcDvcOs = iif (MessageSource == \"Linux\", \"Linux\", \"Windows\")\r\n;\r\nlet InboundNetworkEvents = \r\n  DirectionNetworkEvents\r\n  | where not(outbound)\r\n  | invoke parser ()\r\n  | project-rename\r\n     DstBytes = BytesOut,\r\n     SrcBytes = BytesIn,\r\n     DstPortNumber = LocalPort,\r\n     SrcIpAddr = RemoteAddress,\r\n     SrcPortNumber = RemotePort,\r\n     DstProcessId = ProcessId\r\n   | extend\r\n      DstIpAddr = LocalAddress,\r\n     DstDvcIdType = \"MD4IoTid\",\r\n     DstUserId = UserId,\r\n     DstUserIdType = \"UID\",\r\n     DstDvcId = DeviceId,\r\n     Process = DstProcessId, // alias\r\n     DstDvcOs = iif (MessageSource == \"Linux\", \"Linux\", \"Windows\")\r\n;\r\nlet NetworkSessionMD4IoT = \r\n  union InboundNetworkEvents, OutboundNetworkEvents\r\n   | extend\r\n    EventCount = int(1),\r\n    EventProduct = 'Azure Defender for IoT', \r\n    EventVendor = 'Microsoft',\r\n    EventSchemaVersion = '0.2.0',\r\n    EventSchema = \"NetworkSession\", \r\n    EventType = 'NetworkSession',\r\n    EventStartTime = TimeGenerated, // Open question about timestamps\r\n    EventEndTime = TimeGenerated,  // Open question about timestamps\r\n    EventResult = 'Success',\r\n    EventSeverity = 'Informational'\r\n  | project-rename\r\n     EventProductVersion = AgentVersion, // Not available in Windows\r\n     _ResourceId = AssociatedResourceId, \r\n     _SubscriptionId = AzureSubscriptionId, \r\n    EventOriginalUid = OriginalEventId,  // OK pending question\r\n    DvcOs = MessageSource,\r\n    NetworkProtocol = Protocol,\r\n    NetworkApplicationProtocol = ApplicationProtocol,\r\n    DvcId = DeviceId,\r\n    DvcIpAddr = LocalAddress\r\n  | extend\r\n    Dvc = DvcId,\r\n    DvcIdType = \"MD4IoTid\",\r\n    User = UserId,\r\n    IpAddr = SrcIpAddr,\r\n    Src = SrcIpAddr,\r\n    Dst = DstIpAddr\r\n  | project-away outbound\r\n;\r\nNetworkSessionMD4IoT\r\n", "params": "disabled:bool = false"}}